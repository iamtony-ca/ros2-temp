안녕하세요. ROS 2 Nav2 및 Smac Planner 전문가로서 답변드립니다.

협소한 공간에서 **AMR 두 대가 교행하기 위해 서로 벽에 최대한 붙어야 하는 상황**은 물류 로봇 현장에서 빈번히 발생하는, 아주 까다롭지만 필수적인 요구사항입니다.

현재 사용 중인 `SmacPlannerHybrid`는 기본적으로 **안전 확보를 위해 통로의 중앙(Cost가 낮은 지점)으로 주행하려는 성향(Centering)**이 강합니다. 벽에 붙으려면 이 본능을 억제해야 합니다.

벽에 밀착된 경로를 생성하기 위한 핵심 파라미터 튜닝 가이드와 그 이유를 단계별로 설명해 드리겠습니다.

---

### 1. 핵심 파라미터 튜닝 (Planner Parameter)

Planner 관점에서 가장 중요한 것은 **"장애물 근처(High Cost)를 지나는 것에 대한 페널티를 없애는 것"**입니다.

#### A. `cost_penalty` (가장 중요)

* **현재 값:** `0.7`
* **추천 값:** **`0.0`** (또는 극도로 낮은 값)
* **이유:**
* 이 파라미터는 경로 탐색 시 Costmap의 비용(장애물과의 거리)을 얼마나 가중치로 둘지 결정합니다.
* 값이 높으면 로봇은 비용이 0인 중앙으로 가려 하고, 값이 낮으면 장애물 근처의 비용을 무시하고 최단 거리(직선)를 그립니다.
* `0.0`으로 설정하면 충돌(Lethal)만 아니라면 벽 옆의 높은 Cost 영역도 거리상 이득이 있다면 과감하게 선택합니다. 벽에 붙으려면 이 값을 과감히 0으로 낮추세요.



#### B. `use_quadratic_cost_penalty`

* **현재 값:** `true`
* **추천 값:** **`false`**
* **이유:**
* Cost 함수를 2차(Quadratic)로 계산하면 장애물 근처의 비용이 기하급수적으로 커져서 로봇이 벽에서 튕겨져 나오듯 중앙으로 밀립니다.
* `false`(선형, Linear)로 변경하여 벽 근처 주행에 대한 거부감을 줄여야 합니다.



#### C. `smoother.w_data` (스무더 가중치)

* **현재 값:** `0.2`
* **추천 값:** **`0.45` ~ `0.5**`
* **이유:**
* Planner가 벽에 붙은 경로를 찾았더라도, 후처리인 Smoother가 경로를 매끄럽게 편다고 다시 중앙으로 당겨버릴 수 있습니다.
* `w_data`는 "원본 경로를 얼마나 유지할 것인가"입니다. 이 값을 높여 Planner가 찾은 '벽에 붙은 경로' 형상을 스무딩 단계에서도 유지하게 해야 합니다.



#### D. `non_straight_penalty`

* **현재 값:** `1.5`
* **추천 값:** **`1.05` ~ `1.2**`
* **이유:**
* 벽에 붙어서 주행하려면 미세한 조향(Curve)이 필요할 수 있습니다. 이 페널티가 너무 크면 로봇은 벽의 굴곡을 무시하고 중앙의 직선 도로를 선호하게 됩니다. 약간 낮춰주는 것이 좋습니다.



---

### 2. 추천 설정 코드 (YAML)

아래는 변경된 값을 적용한 설정 예시입니다.

```yaml
      plugin: "nav2_smac_planner::SmacPlannerHybrid"
      # ... (생략) ...
      
      # [핵심 변경 1] 장애물 근처 주행 페널티 제거
      # 벽에 붙으려면 장애물 근처의 비용을 탐색 비용에 추가하지 않아야 합니다.
      cost_penalty: 0.0  # 기존 0.7 -> 0.0 (강력 추천)
      
      # [핵심 변경 2] 비용 증가폭 완화
      use_quadratic_cost_penalty: false # 기존 true -> false
      
      # [보조 변경] 벽의 형상을 따르기 위해 직진 강요 완화
      non_straight_penalty: 1.1 # 기존 1.5 -> 1.1
      
      # ... (생략) ...
      
      smooth_path: true
      smoother:
        max_iterations: 1000
        w_smooth: 0.3
        
        # [핵심 변경 3] 원본(벽에 붙은) 경로 유지 비중 강화
        w_data: 0.5 # 기존 0.2 -> 0.5
        
        tolerance: 1.0e-10
        do_refinement: true
        refinement_num: 2

```

---

### 3. 필수로 확인해야 할 외부 요인 (Costmap)

Planner 파라미터만으로는 한계가 있을 수 있습니다. **Global Costmap 설정이 사실상 경로의 "도로 폭"을 결정**하기 때문입니다. Planner 설정을 변경해도 변화가 적다면 아래 내용을 반드시 확인하세요.

#### `inflation_layer`의 `cost_scaling_factor`

로봇이 벽에 붙지 못하는 가장 큰 이유는 Costmap 상에서 벽 주변이 '위험하다'고 팽창(Inflation)되어 있기 때문입니다.

* **설정 파일 위치:** `global_costmap`의 `inflation_layer` 설정
* **조치:** `cost_scaling_factor` 값을 **대폭 키우세요**.
* 예: `3.0` -> `10.0` 또는 `15.0`


* **원리:** Scaling factor가 크면 장애물 비용이 거리 조금만 멀어져도 급격히 0으로 떨어집니다. 즉, **"벽 바로 옆도 안전하다"**라고 Planner를 속이는 효과가 있어 벽에 더 바짝 붙을 수 있습니다.

### 요약 및 주의사항

1. **`cost_penalty: 0.0`** 설정이 가장 효과적입니다. (Costmap의 비용보다 거리(유클리드)를 최우선시)
2. **`smoother.w_data`**를 올려서 후처리 과정에서 경로가 펴지는 것을 막으세요.
3. 그래도 부족하다면 **Global Costmap의 `cost_scaling_factor`를 높여서** 인플레이션 영역을 급격하게 줄이세요.

**주의:** 벽에 너무 가까이 붙으면 센서 노이즈나 제어 오차로 인해 실제 벽과 긁힐(Scraping) 위험이 커집니다. `padding`이나 `footprint`를 실제보다 아주 약간(1~2cm) 크게 잡아서 물리적 충돌 마진을 남겨두는 것을 권장합니다.

#########################################  
##########################################  
###########################################  
`GracefulController`에서 **"Yaw(자세) 추종보다 Position(위치) 추종을 더 우선시"** 하도록 만드는 것은, 로봇이 경로의 **방향성(Heading)**을 맞추려고 애쓰기보다, **경로 위의 점(Point) 자체에 도달**하려고 노력하게 만드는 것과 같습니다.

이를 위해 가장 핵심적인 파라미터는 `k_phi`이며, 그 외 반응성을 높이는 파라미터들을 함께 조절해야 합니다.

아래는 **Position Tracking 성능을 극대화**하기 위한 추천 설정과 그 이유입니다.

---

### 1. 핵심 튜닝 가이드

#### A. `k_phi` (가장 중요)

* **현재 값:** `1.0`
* **추천 값:** **`0.4` ~ `0.5**`
* **이유:**
* `k_phi`는 로봇이 **"경로의 방향(각도)"**과 **"목표 지점까지의 거리"** 중 무엇을 더 중요하게 생각할지 결정하는 가중치입니다.
* 이 값이 **낮을수록** 로봇은 내 몸의 각도가 틀어지든 말든, 일단 **목표 좌표(x, y)로 가는 것을 최우선**으로 합니다. (마치 Pure Pursuit 처럼 동작하게 됨)
* 반대로 값이 높으면 경로와 나란해지기 위해 위치 오차를 허용하면서 부드럽게 진입하려 합니다. 위치 추적을 강화하려면 이 값을 **과감히 낮춰야 합니다**.



#### B. `k_delta` (복원력 강화)

* **현재 값:** `0.8`
* **추천 값:** **`1.2` ~ `1.5**`
* **이유:**
* 경로에서 벗어났을 때 얼마나 **급격하게(Aggressively)** 핸들을 꺾어서 경로로 복귀할지 결정합니다.
* 위치 추적이 중요하다는 것은 경로에서 조금만 벗어나도 즉시 반응해야 함을 의미합니다. 값을 높여서 **조향 반응성을 민감하게** 만드세요.



#### C. `min_lookahead` (코너 커팅 방지)

* **현재 값:** `0.60`
* **추천 값:** **`0.4` ~ `0.5**`
* **이유:**
* Lookahead 거리가 멀면 로봇은 경로를 가로질러(Shortcut) 가게 되어 곡선 구간에서 벽과의 거리가 멀어지거나 가까워지는 등 오차가 생깁니다.
* 이 값을 줄여서 로봇 바로 앞의 경로를 보게 하면, **경로의 굴곡을 더 정밀하게 따라갑니다.** (단, 너무 줄이면 좌우로 흔들릴 수 있습니다.)



#### D. `lambda` (경로 밀착력)

* **현재 값:** `1.5`
* **추천 값:** **`1.0`**
* **이유:**
* `lambda`는 곡선을 그리는 호(Arc)의 형태를 결정합니다. 값이 크면 부드럽고 넓은 호를 그리며 경로에서 살짝 뜨게 됩니다.
* 값을 `1.0` 근처로 낮추면 곡선 구간에서 **더 날카롭게 꺾어 경로에 밀착**하려는 성향이 강해집니다.



---

### 2. 추천 설정 코드 (YAML)

```yaml
      plugin: "nav2_graceful_controller::GracefulController"

      # 속도 관련 (Velocity)
      v_linear_max: 0.55
      v_linear_min: 0.02
      v_angular_max: 1.0

      # [튜닝 포인트 1] Lookahead를 줄여서 경로를 더 촘촘하게 추종
      min_lookahead: 0.45  # 기존 0.60 -> 0.45
      max_lookahead: 1.0

      # [튜닝 포인트 2] 핵심 제어 법칙 변경
      # Yaw(자세)보다 Position(위치) 우선: k_phi 감소
      k_phi: 0.5           # 기존 1.0 -> 0.5 (위치 추적 강화의 핵심)
      
      # 경로 이탈 시 빠른 복귀: k_delta 증가
      k_delta: 1.3         # 기존 0.8 -> 1.3 (반응성 강화)

      # [튜닝 포인트 3] 곡선 주행
      beta: 0.25
      # 경로 밖으로 밀려나지 않도록 타이트하게 선회
      lambda: 1.0          # 기존 1.5 -> 1.0

      # 목표 지점 동작 (Goal Behavior)
      slowdown_radius: 1.0
      initial_rotation: false
      initial_rotation_tolerance: 1.5
      prefer_final_rotation: false
      v_angular_min_in_place: 0.03

      # 기타 설정
      transform_tolerance: 0.1
      allow_backward: false
      use_collision_detection: true
      max_robot_pose_search_dist: 5.0

```

### 요약

1. **`k_phi`를 낮춘다 (1.0 -> 0.5):** "내 몸의 각도가 좀 삐뚤어져도 좋으니, 선 위에 바퀴를 올려라"라고 명령하는 것과 같습니다.
2. **`k_delta`를 높인다 (0.8 -> 1.3):** 경로에서 1cm라도 벗어나면 핸들을 빨리 꺾어 복귀하도록 합니다.
3. **`min_lookahead`를 줄인다 (0.6 -> 0.45):** 너무 먼 미래를 보지 말고 바로 앞의 경로를 따라가게 하여 코너링 오차를 줄입니다.

이렇게 설정하면 로봇이 경로(Path)라는 '선'을 밟고 가는 능력은 매우 좋아지지만, 주행 모습이 약간 뱀처럼 꼬물거리거나(Oscillation), 조향이 거칠어질 수 있습니다. 이 점은 감안하셔야 합니다.

