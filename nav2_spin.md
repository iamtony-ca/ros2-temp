λ„¤, μ •ν™•ν μ§μΌμ…¨μµλ‹λ‹¤. `Spin` λ™μ‘ μ¤‘μ—λ„ **μ§€μ†μ μΌλ΅ μ¥μ• λ¬Ό μ²΄ν¬λ¥Ό ν•©λ‹λ‹¤.**

μ‚¬μ©μλ‹μ μ¤ν•΄λ” `onRun`κ³Ό `onCycleUpdate`μ μ—­ν• μ„ νΌλ™ν•μ‹  κ²ƒμΌ μ μμµλ‹λ‹¤. `Spin` λ…Έλ“λ” Nav2μ `TimedBehavior`λ¥Ό μƒμ†λ°›μΌλ©°, Behavior Tree(BT)μ— μν•΄ λ°λ³µμ μΌλ΅ 'ν‹±(tick)'λ©λ‹λ‹¤.

μ½”λ“λ¥Ό μμ„Έν μ‚΄ν΄λ³΄λ©΄ λ™μ‘ λ°©μ‹μ€ λ‹¤μκ³Ό κ°™μµλ‹λ‹¤.

-----

### 1\. `onRun()` : μµμ΄ μ„¤μ • (λ‹¨ ν• λ²)

`onRun` ν•¨μλ” `Spin` ν–‰λ™μ΄ **μ²μ μ‹μ‘λ  λ• λ‹¨ ν• λ²λ§ νΈμ¶**λ©λ‹λ‹¤.

  * μ΄ ν•¨μλ” λ©ν‘ νμ „κ°(`cmd_yaw_`)μ„ μ„¤μ •ν•κ³ , νƒ€μ„μ•„μ›ƒ(`end_time_`)μ„ μ„¤μ •ν•λ” λ“± μ΄κΈ°ν™” μ‘μ—…λ§ μν–‰ν•©λ‹λ‹¤.
  * μ—¬κΈ°μ„λ” `vel_pub_->publish()`λ‚ `isCollisionFree()`κ°€ νΈμ¶λμ§€ μ•μµλ‹λ‹¤. μ¦‰, **`onRun`μ—μ„λ” μ‹¤μ  λ΅λ΄‡μ„ μ›€μ§μ΄κ±°λ‚ μ¶©λ κ²€μ‚¬λ¥Ό ν•μ§€ μ•μµλ‹λ‹¤.**

-----

### 2\. `onCycleUpdate()` : μ‹¤μ  λ™μ‘ λ£¨ν”„ (λ°λ³µ νΈμ¶)

`onCycleUpdate` ν•¨μλ” BTκ°€ `Spin` λ…Έλ“λ¥Ό μ‹¤ν–‰ν•λ” λ™μ• **λ§¤ ν‹±(tick)λ§λ‹¤ λ°λ³µμ μΌλ΅ νΈμ¶**λ©λ‹λ‹¤. μ‹¤μ  νμ „ λ…λ Ήκ³Ό μ¶©λ κ²€μ‚¬λ” λ¨λ‘ μ΄ ν•¨μ μ•μ—μ„ μ΄λ£¨μ–΄μ§‘λ‹λ‹¤.

`onCycleUpdate`μ λ§¤ ν‹±λ§λ‹¤μ νλ¦„μ€ λ‹¤μκ³Ό κ°™μµλ‹λ‹¤.

1.  **μ‹κ°„ μ΄κ³Ό ν™•μΈ**: `command_time_allowance_`λ¥Ό λ„μ—λ”μ§€ ν™•μΈν•©λ‹λ‹¤.
2.  **ν„μ¬ μμ„Έ νλ“**: ν„μ¬ λ΅λ΄‡μ μμ„Έ(`current_pose`)λ¥Ό κ°€μ Έμµλ‹λ‹¤.
3.  **μ§„ν–‰ μƒν™© κ³„μ‚°**: μ–Όλ§λ‚ νμ „ν–λ”μ§€(`relative_yaw_`) κ³„μ‚°ν•©λ‹λ‹¤.
4.  **λ©ν‘ λ„λ‹¬ ν™•μΈ**: λ©ν‘ κ°λ„(`cmd_yaw_`)μ— λ„λ‹¬ν–μΌλ©΄ `stopRobot()`μ„ νΈμ¶ν•κ³  `SUCCEEDED`λ¥Ό λ°ν™ν•©λ‹λ‹¤.
5.  **μ†λ„ κ³„μ‚°**: λ©ν‘κΉμ§€ λ‚¨μ€ κ°λ„(`remaining_yaw`)λ¥Ό λ°”νƒ•μΌλ΅ μ΄λ² ν‹±μ—μ„ μ‚¬μ©ν•  κ°μ†λ„(`vel`)λ¥Ό κ³„μ‚°ν•©λ‹λ‹¤.
6.  **`cmd_vel` μƒμ„±**: κ³„μ‚°λ μ†λ„λ΅ `TwistStamped` λ©”μ‹μ§€λ¥Ό μƒμ„±ν•©λ‹λ‹¤.
7.  **π’¥ ν•µμ‹¬: μ¶©λ κ²€μ‚¬ λ° μ‹λ®¬λ μ΄μ…**
    ```cpp
    if (!isCollisionFree(relative_yaw_, cmd_vel->twist, pose2d)) {
    Β  Β  stopRobot();
    Β  Β  RCLCPP_WARN(logger_, "Collision Ahead - Exiting Spin");
    Β  Β  return ResultStatus{Status::FAILED, SpinActionResult::COLLISION_AHEAD};
    }
    ```
      * λ°”λ΅ μ΄ λ¶€λ¶„μ—μ„ `isCollisionFree` ν•¨μκ°€ νΈμ¶λ©λ‹λ‹¤.
      * `isCollisionFree`λ” **ν„μ¬ κ³„μ‚°λ μ†λ„(`cmd_vel`)λ΅ μ•μΌλ΅ `simulate_ahead_time_` (κΈ°λ³Έκ°’ 2.0μ΄) λ™μ• νμ „ν•  κ²½μ°μ λ―Έλ κ²½λ΅λ¥Ό μ‹λ®¬λ μ΄μ…**ν•©λ‹λ‹¤.
      * μ΄ μ‹λ®¬λ μ΄μ… κ²½λ΅λ” `local_collision_checker_` (μ¦‰, **Local Costmap**)λ¥Ό κΈ°λ°μΌλ΅ μ¶©λ μ—¬λ¶€λ¥Ό κ²€μ‚¬ν•©λ‹λ‹¤.
8.  **μ•μ „ν•  κ²½μ°μ—λ§ μ†λ„ κ²μ‹**
    ```cpp
    vel_pub_->publish(std::move(cmd_vel));
    ```
      * `isCollisionFree` κ²€μ‚¬λ¥Ό ν†µκ³Ό(μ¶©λ μ—†μ)ν–μ„ λ•λ§ `vel_pub_`λ¥Ό ν†µν•΄ μ‹¤μ  λ΅λ΄‡μ— μ†λ„ λ…λ Ήμ„ μ „μ†΅ν•©λ‹λ‹¤.
9.  **`RUNNING` λ°ν™**: μ•„μ§ λ©ν‘μ— λ„λ‹¬ν•μ§€ μ•μ•μΌλ―€λ΅ `RUNNING` μƒνƒλ¥Ό λ°ν™ν•μ—¬ BTκ°€ λ‹¤μ ν‹±μ—λ„ `onCycleUpdate`λ¥Ό νΈμ¶ν•λ„λ΅ ν•©λ‹λ‹¤.

-----

### μ”μ•½

`Spin` λ…Έλ“λ” "νμ „ μ‹μ‘" λ…λ Ήμ„ ν• λ² λ‚΄λ¦¬κ³  λλ‚λ” κ²ƒμ΄ μ•„λ‹λΌ, BTμ ν‹± μ£ΌκΈ°μ— λ§μ¶° \*\*"μ‚΄μ§ νμ „ β†’ λ―Έλ κ²½λ΅ μ¶©λ κ²€μ‚¬ β†’ μ•μ „ν•λ©΄ μ‚΄μ§ νμ „ β†’ λ―Έλ κ²½λ΅ μ¶©λ κ²€μ‚¬ β†’ ..."\*\*λ¥Ό λ°λ³µν•λ” κµ¬μ΅°μ…λ‹λ‹¤.

λ”°λΌμ„ `Spin` λ™μ‘ μ¤‘μ— Local Costmapμ΄ μ—…λ°μ΄νΈλμ–΄ μ¥μ• λ¬Όμ΄ κ°μ§€λλ©΄, **λ‹¤μ `onCycleUpdate` ν‹±μ `isCollisionFree` νΈμ¶μ—μ„ μ¦‰μ‹ κ°μ§€**λκ³  λ΅λ΄‡μ€ λ©μ¶”κ² λ©λ‹λ‹¤.


#####################  
######################  
λ„¤, `spin.cpp` μ½”λ“μ— λ“±μ¥ν•λ” μ£Όμ” νλΌλ―Έν„°λ“¤μ— λ€ν•΄ μ„¤λ…ν•΄ λ“λ¦¬κ² μµλ‹λ‹¤.

μ΄ νλΌλ―Έν„°λ“¤μ€ ν¬κ² λ‘ κ°€μ§€λ΅ λ‚λ‰©λ‹λ‹¤.
1.  **ROS 2 νλΌλ―Έν„°**: λ…Έλ“κ°€ λ΅λ“λ  λ• YAML νμΌ λ“±μ„ ν†µν•΄ μ„¤μ •ν•λ” κ°’μ…λ‹λ‹¤. (μ£Όλ΅ `onConfigure` ν•¨μμ—μ„ λ΅λ“)
2.  **Behavior Tree μ…λ ¥ (Action Goal)**: BT XML νμΌμ—μ„ `Spin` λ…Έλ“λ¥Ό νΈμ¶ν•  λ• `input_port`λ¥Ό ν†µν•΄ μ „λ‹¬ν•λ” κ°’μ…λ‹λ‹¤. (μ£Όλ΅ `onRun` ν•¨μμ—μ„ μ½μ)

---

### 1. ROS 2 νλΌλ―Έν„° (YAML μ„¤μ •)

μ΄ κ°’λ“¤μ€ `nav2_params.yaml` (λλ” μ„¤μ • νμΌ)μ `spin_behavior` (BT Navigatorμ Behavior Server ν”λ¬κ·ΈμΈ μ„¤μ •) μ„Ήμ…μ—μ„ μ„¤μ •ν•©λ‹λ‹¤.

* `**simulate_ahead_time**`
    * **μ„¤λ…**: μ¶©λ κ²€μ‚¬λ¥Ό μ„ν•΄ **λ―Έλ¦¬ μ‹λ®¬λ μ΄μ…ν•  μ‹κ°„(μ΄)**μ…λ‹λ‹¤.
    * **μ©λ„**: `onCycleUpdate` λ£¨ν”„κ°€ λ λ•λ§λ‹¤, `isCollisionFree` ν•¨μλ” ν„μ¬ μ†λ„λ΅ μ΄ μ‹κ°„λ§νΌ λ―Έλμ— λ΅λ΄‡μ΄ μμ„ μ„μΉκΉμ§€μ κ¶¤μ μ„ κ³„μ‚°ν•©λ‹λ‹¤. κ·Έλ¦¬κ³  κ·Έ κ¶¤μ μ΄ Local Costmap μƒμ—μ„ μ¥μ• λ¬Όκ³Ό μ¶©λν•λ”μ§€ κ²€μ‚¬ν•©λ‹λ‹¤.
    * **κΈ°λ³Έκ°’**: 2.0 (μ΄)

* `**max_rotational_vel**`
    * **μ„¤λ…**: λ΅λ΄‡μ΄ νμ „ν•  λ• λ„λ‹¬ν•  μ μλ” **μµλ€ κ°μ†λ„ (rad/s)**μ…λ‹λ‹¤.
    * **μ©λ„**: `onCycleUpdate`μ—μ„ κ³„μ‚°λ μ†λ„(`vel`)κ°€ μ΄ κ°’μ„ μ΄κ³Όν•μ§€ μ•λ„λ΅ μ ν•ν•©λ‹λ‹¤.
    * **κΈ°λ³Έκ°’**: 1.0 (rad/s)

* `**min_rotational_vel**`
    * **μ„¤λ…**: λ΅λ΄‡μ΄ νμ „ν•  λ• μ μ§€ν•΄μ•Ό ν•  **μµμ† κ°μ†λ„ (rad/s)**μ…λ‹λ‹¤.
    * **μ©λ„**: λ©ν‘ κ°λ„μ— κ±°μ λ„λ‹¬ν•μ—¬ κ³„μ‚°λ μ†λ„κ°€ μ΄ κ°’λ³΄λ‹¤ λλ ¤μ§€λ”λΌλ„, μµμ†ν• μ΄ μ†λ„λ΅λ” νμ „ν•λ„λ΅ λ³΄μ¥ν•©λ‹λ‹¤. μ΄λ” λ΅λ΄‡μ΄ λ„λ¬΄ λλ¦° μ†λ„ λ…λ Ήμ— λ°μ‘ν•μ§€ μ•κ±°λ‚ λ©μΉ«κ±°λ¦¬λ” ν„μƒμ„ λ°©μ§€ν•©λ‹λ‹¤.
    * **κΈ°λ³Έκ°’**: 0.4 (rad/s)

* `**rotational_acc_lim**`
    * **μ„¤λ…**: λ΅λ΄‡μ **κ°κ°€μ†λ„ μ ν• (rad/sΒ²)**μ…λ‹λ‹¤.
    * **μ©λ„**: `onCycleUpdate`μ—μ„ λ‚¨μ€ νμ „ κ°λ„(`remaining_yaw`)λ¥Ό λ°”νƒ•μΌλ΅ ν„μ¬ ν‹±μ—μ„ μ‚¬μ©ν•  μ†λ„λ¥Ό κ³„μ‚°ν•  λ• μ‚¬μ©λ©λ‹λ‹¤. (`vel = sqrt(2 * rotational_acc_lim_ * remaining_yaw)`) μ΄λ” λ©ν‘ μ§€μ μ— κ°€κΉμ›μ§μλ΅ λ¶€λ“λ½κ² κ°μ†ν•λ” ν”„λ΅νμΌμ„ λ§λ“λ” λ° μ‚¬μ©λ©λ‹λ‹¤.
    * **κΈ°λ³Έκ°’**: 3.2 (rad/sΒ²)

---

### 2. Behavior Tree μ…λ ¥ (Action Goal)

μ΄ κ°’λ“¤μ€ Behavior Treeμ XML νμΌ λ‚΄μ—μ„ `Spin` λ…Έλ“μ— **Input Port**λ΅ μ „λ‹¬λ©λ‹λ‹¤.

* `**target_yaw**`
    * **μ„¤λ…**: **λ©ν‘ νμ „ κ°λ„ (rad)**μ…λ‹λ‹¤.
    * **μ©λ„**: λ΅λ΄‡μ΄ ν„μ¬ μμ„Έλ¥Ό κΈ°μ¤€μΌλ΅ μ–Όλ§λ§νΌ νμ „ν•΄μ•Ό ν•λ”μ§€λ¥Ό μ§€μ •ν•©λ‹λ‹¤. μ–‘μ(+)λ” λ°μ‹κ³„ λ°©ν–¥(CCW), μμ(-)λ” μ‹κ³„ λ°©ν–¥(CW) νμ „μ„ μλ―Έν•©λ‹λ‹¤.
    * **μ½”λ“ μ„μΉ**: `onRun` ν•¨μμ—μ„ `command->target_yaw`λ΅ μ½μ–΄μµλ‹λ‹¤.

* `**time_allowance**`
    * **μ„¤λ…**: `Spin` λ™μ‘μ„ μ™„λ£ν•λ” λ° ν—μ©λλ” **μµλ€ μ‹κ°„ (μ΄)**μ…λ‹λ‹¤.
    * **μ©λ„**: `onCycleUpdate`μ—μ„ μ΄ μ‹κ°„μ„ μ΄κ³Όν•λ©΄ `Spin` ν–‰λ™μ€ `TIMEOUT` μƒνƒλ΅ μ‹¤ν¨(FAILED) μ²λ¦¬λ©λ‹λ‹¤. λ§μ•½ 0.0μΌλ΅ μ„¤μ •ν•λ©΄ μ‹κ°„μ ν• μ—†μ΄ λ™μ‘ν•©λ‹λ‹¤.
    * **μ½”λ“ μ„μΉ**: `onRun` ν•¨μμ—μ„ `command->time_allowance`λ΅ μ½μ–΄μµλ‹λ‹¤.

κ¶κΈν• μ μ΄ λ” μμΌμ‹ κ°€μ”?
